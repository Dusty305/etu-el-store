//src\app.js
import express from 'express';
import mongoose from 'mongoose';
import path from 'path';
import { fileURLToPath } from 'url';
import sessionMiddleware from './middleware/session.js';
import corsMiddleware from './middleware/cors.js';
import errorMiddleware from './middleware/errorHandler.js';
import { attachUser } from './middleware/auth.js';
import authRoutes from './routes/authRoutes.js';
import productRoutes from './routes/productRoutes.js';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const app = express();

mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/el-store-db')
    .then(() => console.log('Connected to MongoDB'))
    .catch(err => console.error('MongoDB connection error:', err));

app.use(express.json());
app.use(sessionMiddleware);
app.use(attachUser);
app.use(corsMiddleware);

// API Routes
app.use('/api/auth', authRoutes);
app.use('/api/product', productRoutes);

if (process.env.NODE_ENV === 'production') {
  app.use(express.static(path.join(__dirname, 'public')));
  app.get('*', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
  });
}

app.use(errorMiddleware);

app.use('*', (req, res) => {
  res.status(404).json({ error: 'Маршрут не найден' });
});

const PORT = process.env.PORT || 5000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
//src\controllers\authController.js
import User from '../models/User.js';
import { hashPassword, comparePassword, validatePassword } from '../utils/password.js';

export const register = async (req, res) => {
    try {
        const { login, displayName, email, password } = req.body;

        if (!login || !displayName || !email || !password) {
            return res.status(400).json({ error: 'Все поля обязательны для заполнения' });
        }

        const passwordError = validatePassword(password);
        if (passwordError) {
            return res.status(400).json({ error: passwordError });
        }

        const existingUser = await User.findOne({
            $or: [{ login }, { email }]
        });

        if (existingUser) {
            return res.status(400).json({ error: 'Пользователь с таким логином или email уже существует' });
        }

        // Создание пользователя
        const passwordHash = await hashPassword(password);
        const user = new User({
            login,
            displayName,
            email,
            passwordHash,
            role: 'ПОКУПАТЕЛЬ'
        });

        await user.save();

        // Автоматический логин после регистрации
        req.session.userId = user._id.toString();
        req.session.userLogin = user.login;
        req.session.userRole = user.role;

        res.status(201).json({
            message: 'Пользователь успешно зарегистрирован',
            user: {
                id: user._id,
                login: user.login,
                displayName: user.displayName,
                email: user.email,
                role: user.role
            }
        });
    } catch (error) {
        console.error('Ошибка регистрации:', error);
        res.status(500).json({ error: 'Внутренняя ошибка сервера' });
    }
};

export const login = async (req, res) => {
    try {
        const { login, password } = req.body;

        if (!login || !password) {
            return res.status(400).json({ error: 'Логин и пароль обязательны' });
        }

        // Поиск пользователя
        const user = await User.findOne({
            $or: [{ login }, { email: login }]
        });

        if (!user) {
            return res.status(401).json({ error: 'Неверный логин или пароль' });
        }

        // Проверка пароля
        const isPasswordValid = await comparePassword(password, user.passwordHash);
        if (!isPasswordValid) {
            return res.status(401).json({ error: 'Неверный логин или пароль' });
        }

        // Создание сессии
        req.session.userId = user._id.toString();
        req.session.userLogin = user.login;
        req.session.userRole = user.role;

        res.json({
            message: 'Успешный вход в систему',
            user: {
                id: user._id,
                login: user.login,
                displayName: user.displayName,
                email: user.email,
                role: user.role
            }
        });
    } catch (error) {
        console.error('Ошибка входа:', error);
        res.status(500).json({ error: 'Внутренняя ошибка сервера' });
    }
};

export const logout = (req, res) => {
    req.session.destroy((err) => {
        if (err) {
            return res.status(500).json({ error: 'Ошибка при выходе' });
        }
        res.clearCookie('sessionId');
        res.json({ message: 'Успешный выход из системы' });
    });
};

export const getCurrentUser = async (req, res) => {
    try {
        if (!req.session.userId) {
            return res.status(200).json({ user: null });
        }

        const user = await User.findById(req.session.userId)
            .select('-passwordHash');

        if (!user) {
            // Если пользователь не найден, очищаем сессию
            req.session.destroy();
            return res.status(200).json({ user: null });
        }

        res.json({
            user: {
                id: user._id,
                login: user.login,
                displayName: user.displayName,
                email: user.email,
                role: user.role
            }
        });
    } catch (error) {
        console.error('Ошибка получения пользователя:', error);
        res.status(500).json({ error: 'Внутренняя ошибка сервера' });
    }
};
//src\controllers\productController.js
import ProductModel from '../models/Product.js';

export const products = async (req, res) => {
    try {
        const products = await ProductModel.find();
        res.json({
            products: products
        });
    } catch (error) {
        console.error('Ошибка получения информации о продуктах:', error);
        res.status(500).json({ error: 'Внутренняя ошибка сервера' });
    }
}
//src\middleware\auth.js
export const requireAuth = (req, res, next) => {
    if (!req.session.userId) {
        return res.status(401).json({ error: 'Требуется авторизация' });
    }
    next();
};

export const requireAdmin = (req, res, next) => {
    if (!req.session.userId) {
        return res.status(401).json({ error: 'Требуется авторизация' });
    }
    if (req.session.userRole !== 'АДМИНИСТРАТОР') {
        return res.status(403).json({ error: 'Недостаточно прав' });
    }
    next();
};

export const attachUser = (req, res, next) => {
    if (req.session.userId) {
        req.user = {
            id: req.session.userId,
            login: req.session.userLogin,
            role: req.session.userRole
        };
    }
    next();
};
//src\middleware\cors.js
import cors from "cors";

export default cors({
    origin: 'http://localhost:3000',
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization']
});
//src\middleware\errorHandler.js
export default (err, req, res, _) => {
    console.error(err.stack);
    res.status(500).json({ error: 'Внутренняя ошибка сервера' });
}
//src\middleware\session.js
import session from 'express-session';
import MongoStore from 'connect-mongo';

export default session({
    name: 'sessionId',
    secret: process.env.SESSION_SECRET || 'your-secret-key-change-in-production',
    resave: false,
    saveUninitialized: false,
    store: MongoStore.create({
        mongoUrl: process.env.MONGODB_URI || 'mongodb://localhost:27017/el-store-db',
        ttl: 24 * 60 * 60 // 1 день
    }),
    cookie: {
        maxAge: 24 * 60 * 60 * 1000, // 1 день
        httpOnly: true,
        secure: process.env.NODE_ENV === 'production',
        sameSite: 'lax'
    }
});
//src\models\Cart.js
import mongoose from 'mongoose';
import cartSchema from './schemas/cart-schema.js';

export default mongoose.model('Cart', cartSchema);
//src\models\Category.js
import mongoose from 'mongoose';
import categorySchema from './schemas/category-schema.js';

export default mongoose.model('Category', categorySchema);
//src\models\Order.js
import mongoose from 'mongoose';
import orderSchema from './schemas/order-schema.js';

export default mongoose.model('Order', orderSchema);
//src\models\Product.js
import mongoose from 'mongoose';
import productSchema from './schemas/product-schema.js';

export default mongoose.model('Product', productSchema);
//src\models\schemas\cart-schema.js
import mongoose from "mongoose";

export default new mongoose.Schema({
    userId: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'User',
        required: true,
        unique: true
    },
    items: [{
        productId: {
            type: mongoose.Schema.Types.ObjectId,
            ref: 'Product',
            required: true
        },
        quantity: {
            type: Number,
            required: true,
            min: 1
        }
    }]
});
//src\models\schemas\category-schema.js
import mongoose from "mongoose";

export default new mongoose.Schema({
    name: {
        type: String,
        required: true,
        minlength: 1,
        maxlength: 120
    },
    parentCategory: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'Category',
        default: null
    }
});
//src\models\schemas\order-schema.js
import mongoose from "mongoose";

export default new mongoose.Schema({
    userId: {
        type: mongoose.Schema.Types.ObjectId,
        ref: 'User',
        required: true
    },
    items: [{
        productId: {
            type: mongoose.Schema.Types.ObjectId,
            ref: 'Product',
            required: true
        },
        quantity: {
            type: Number,
            required: true,
            min: 1
        }
    }],
    deliveryInfo: {
        address: {
            type: String,
            required: true
        },
        deliveryTime: {
            type: Date,
            required: true
        },
        courierNotes: {
            type: String,
            default: ''
        }
    },
    paymentInfo: {
        cardNumber: {
            type: String,
            required: true,
            match: [/^\d{16}$/, 'Неверный формат номера карты'],
        },
        cvc: {
            type: String,
            required: true,
            match: [/^\d{3}$/, 'CVC должен содержать 3 или 4 цифры'],
        },
        expirationDate: {
            type: String,
            required: true,
            match: [/^(0[1-9]|1[0-2])\/?([0-9]{2})$/, 'Неверный формат срока действия (MM/YY)'],
        },
    },
    status: {
        type: String,
        enum: ['НОВЫЙ', 'ОПЛАЧЕН', 'ОТМЕНЁН', 'ВЫПОЛНЕН'],
        default: 'НОВЫЙ'
    },
    totalAmount: {
        type: Number,
        required: true,
        min: 0
    },
    createdAt: {
        type: Date,
        default: Date.now
    },
    updatedAt: {
        type: Date,
        default: Date.now
    }
});
//src\models\schemas\product-schema.js
import mongoose from "mongoose";

export default new mongoose.Schema({
    name: {
        type: String,
        required: true,
        minlength: 1,
        maxlength: 255
    },
    description: {
        type: String,
        required: true
    },
    images: [{
        type: String
    }],
    price: {
        type: Number,
        required: true,
        min: 0
    },
    categories: [{
        type: mongoose.Schema.Types.ObjectId,
        ref: 'Category'
    }],
    stock: {
        type: Number,
        required: true,
        min: 0,
        default: 0
    }
});
//src\models\schemas\user-schema.js
import mongoose from 'mongoose';

export default new mongoose.Schema({
    login: {
        type: String,
        required: true,
        unique: true,
        minlength: 1,
        maxlength: 60
    },
    displayName: {
        type: String,
        required: true,
        minlength: 1,
        maxlength: 60
    },
    email: {
        type: String,
        required: true,
        unique: true,
        match: /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    },
    passwordHash: {
        type: String,
        required: true
    },
    role: {
        type: String,
        enum: ['ПОКУПАТЕЛЬ', 'АДМИНИСТРАТОР'],
        default: 'ПОКУПАТЕЛЬ'
    }
});
//src\models\User.js
import mongoose from 'mongoose';
import userSchema from './schemas/user-schema.js';

export default mongoose.model('User', userSchema);
//src\routes\authRoutes.js
import express from 'express';
import {
    register,
    login,
    logout,
    getCurrentUser
} from '../controllers/authController.js';
import { requireAuth } from '../middleware/auth.js';

const router = express.Router();

// Публичные маршруты
router.post('/register', register);
router.post('/login', login);

// Защищенные маршруты
router.post('/logout', requireAuth, logout);
router.get('/me', getCurrentUser);

export default router;
//src\routes\productRoutes.js
import express from 'express';
import {
    products
} from '../controllers/productController.js';

const router = express.Router();

// Публичные маршруты
router.get('/all', products)

// Защищенные маршруты

export default router;
//src\utils\fill-db.js
import mongoose from 'mongoose';

import CategoryModel from '../models/Category.js';
import ProductModel from '../models/Product.js';

mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/el-store-db')
    .then(() => console.log('Connected to MongoDB'))
    .catch(err => console.error('MongoDB connection error:', err));

// Удаляем имеющиеся данные
await CategoryModel.deleteMany({});
await ProductModel.deleteMany({});

async function CreateCategories() {
    try {
        console.log('Начинаем заполнять данными о категориях...')

        // Создаем корневые категории
        const computers = await CategoryModel.create({ name: "Компьютеры и ноутбуки" });
        const mobile = await CategoryModel.create({ name: "Смартфоны и гаджеты" });
        const homeTech = await CategoryModel.create({ name: "Техника для дома" });
        const tv = await CategoryModel.create({ name: "Телевизоры и аудио" });

        // Создаем подкатегории
        await CategoryModel.create([
            // Подкатегории для компьютеров
            {
                name: "Ноутбуки",
                parentCategory: computers._id
            },
            {
                name: "Стационарные компьютеры",
                parentCategory: computers._id
            },
            {
                name: "Комплектующие",
                parentCategory: computers._id
            },
            {
                name: "Периферия",
                parentCategory: computers._id
            },
            
            // Подкатегории для мобильных устройств
            {
                name: "Смартфоны",
                parentCategory: mobile._id
            },
            {
                name: "Планшеты",
                parentCategory: mobile._id
            },
            {
                name: "Умные часы и фитнес-браслеты",
                parentCategory: mobile._id
            },
            {
                name: "Аксессуары",
                parentCategory: mobile._id
            },
            
            // Подкатегории для техники для дома
            {
                name: "Кухонная техника",
                parentCategory: homeTech._id
            },
            {
                name: "Техника для уборки",
                parentCategory: homeTech._id
            },
            {
                name: "Другая техника",
                parentCategory: homeTech._id
            },
            
            // Подкатегории для TV и аудио
            {
                name: "Телевизоры",
                parentCategory: tv._id
            },
            {
                name: "Аудиостанции",
                parentCategory: tv._id
            }
        ]);
        console.log('БД успешно заполнена даными о категориях!')
    } catch (error) {
        console.error('Ошибка при заполнении базы:', error);
    }
}

async function CreateProducts() {
    try {
        console.log('Начинаем заполнять данными о товарах...')
        
        // Находим ID категорий
        const computers = await CategoryModel.findOne({ name: "Компьютеры и ноутбуки" });
        const mobile = await CategoryModel.findOne({ name: "Смартфоны и гаджеты" });
        const homeTech = await CategoryModel.findOne({ name: "Техника для дома" });
        const tv = await CategoryModel.findOne({ name: "Телевизоры и аудио" });
        
        const laptops = await CategoryModel.findOne({ name: "Ноутбуки" });
        const pcs = await CategoryModel.findOne({ name: "Стационарные компьютеры" });
        const components = await CategoryModel.findOne({ name: "Комплектующие" });
        const peripherals = await CategoryModel.findOne({ name: "Периферия" });
        
        const smartphones = await CategoryModel.findOne({ name: "Смартфоны" });
        const tablets = await CategoryModel.findOne({ name: "Планшеты" });
        const smartwatches = await CategoryModel.findOne({ name: "Умные часы и фитнес-браслеты" });
        const mobileAccessories = await CategoryModel.findOne({ name: "Аксессуары" });
        
        const houseAppliances = await CategoryModel.findOne({ name: "Кухонная техника" });
        const cleaningTech = await CategoryModel.findOne({ name: "Техника для уборки" });
        const otherTech = await CategoryModel.findOne({ name: "Другая техника" });
        
        const televisions = await CategoryModel.findOne({ name: "Телевизоры" });
        const audioSystems = await CategoryModel.findOne({ name: "Аудиостанции" });

        // Создаем товары
        const products = await ProductModel.create([
            // ========== НОУТБУКИ ==========
            {
                name: "Apple MacBook Air 13 M2",
                description: "Ультратонкий ноутбук с чипом Apple M2, 13.6-дюймовым дисплеем Retina и до 18 часов автономной работы. Идеален для работы и творчества.",
                images: [],
                price: 119990,
                categories: [computers._id, laptops._id],
                stock: 15
            },
            {
                name: "ASUS ROG Strix G15",
                description: "Игровой ноутбук с процессором Intel Core i7, видеокартой NVIDIA RTX 4060 и 16 ГБ оперативной памяти. Высокая производительность для игр и монтажа видео.",
                images: [],
                price: 149990,
                categories: [computers._id, laptops._id],
                stock: 8
            },
            {
                name: "Lenovo ThinkPad X1 Carbon",
                description: "Бизнес-ноутбук с процессором Intel Core i5, 14-дюймовым дисплеем и премиальной сборкой. Надежность и производительность для деловых задач.",
                images: [],
                price: 135000,
                categories: [computers._id, laptops._id],
                stock: 12
            },

            // ========== СТАЦИОНАРНЫЕ КОМПЬЮТЕРЫ ==========
            {
                name: "HP Pavilion Gaming Desktop",
                description: "Игровой компьютер с процессором AMD Ryzen 5, видеокартой NVIDIA GTX 1660 Super и 512 ГБ SSD. Отличное решение для игр и работы.",
                images: [],
                price: 89990,
                categories: [computers._id, pcs._id],
                stock: 6
            },
            {
                name: "Apple iMac 24\" M3",
                description: "Моноблок с процессором Apple M3, 24-дюймовым 4.5K дисплеем и стильным дизайном. Идеален для творческих профессионалов.",
                images: [],
                price: 199990,
                categories: [computers._id, pcs._id],
                stock: 4
            },

            // ========== КОМПЛЕКТУЮЩИЕ ==========
            {
                name: "NVIDIA GeForce RTX 4070 Ti",
                description: "Игровая видеокарта с 12 ГБ GDDR6X памяти, поддержкой трассировки лучей и DLSS 3. Максимальная производительность в играх 4K.",
                images: [],
                price: 89990,
                categories: [computers._id, components._id],
                stock: 10
            },
            {
                name: "AMD Ryzen 7 7800X3D",
                description: "Процессор с технологией 3D V-Cache, 8 ядер и 16 потоков. Оптимизирован для игр с высокой частотой кадров.",
                images: [],
                price: 45990,
                categories: [computers._id, components._id],
                stock: 20
            },
            {
                name: "Kingston Fury 32GB DDR5",
                description: "Оперативная память DDR5 5600MHz для игровых ПК и рабочих станций. Низкие тайминги и высокая пропускная способность.",
                images: [],
                price: 12990,
                categories: [computers._id, components._id],
                stock: 25
            },

            // ========== СМАРТФОНЫ ==========
            {
                name: "iPhone 15 Pro Max",
                description: "Флагманский смартфон Apple с титановым корпусом, процессором A17 Pro и продвинутой камерой 48 МП. Лучшая производительность на рынке.",
                images: [],
                price: 129990,
                categories: [mobile._id, smartphones._id],
                stock: 18
            },
            {
                name: "Samsung Galaxy S24 Ultra",
                description: "Премиальный смартфон с S-Pen, камерой 200 МП и процессором Snapdragon 8 Gen 3. Искусственный интеллект для повышения продуктивности.",
                images: [],
                price: 109990,
                categories: [mobile._id, smartphones._id],
                stock: 14
            },
            {
                name: "Xiaomi Redmi Note 13 Pro",
                description: "Смартфон среднего класса с AMOLED дисплеем 120 Гц, камерой 200 МП и быстрой зарядкой 67 Вт. Отличное соотношение цены и качества.",
                images: [],
                price: 34990,
                categories: [mobile._id, smartphones._id],
                stock: 30
            },

            // ========== ПЛАНШЕТЫ ==========
            {
                name: "iPad Air 5 10.9\"",
                description: "Мощный планшет с чипом M1, поддержкой Apple Pencil и Magic Keyboard. Универсальное устройство для работы и творчества.",
                images: [],
                price: 69990,
                categories: [mobile._id, tablets._id],
                stock: 9
            },
            {
                name: "Samsung Galaxy Tab S9",
                description: "Флагманский планшет Android с AMOLED дисплеем, S-Pen в комплекте и защитой от воды. Идеален для заметок и мультимедиа.",
                images: [],
                price: 89990,
                categories: [mobile._id, tablets._id],
                stock: 7
            },

            // ========== УМНЫЕ ЧАСЫ И ФИТНЕС-БРАСЛЕТЫ ==========
            {
                name: "Apple Watch Series 9 45mm",
                description: "Умные часы с Always-On дисплеем, функцией измерения ЭКГ и трекингом сна. Интеграция с экосистемой Apple.",
                images: [],
                price: 45990,
                categories: [mobile._id, smartwatches._id],
                stock: 22
            },
            {
                name: "Samsung Galaxy Watch6 Classic",
                description: "Смарт-часы с вращающимся безелем, мониторингом здоровья и премиальным дизайном. Автономность до 40 часов.",
                images: [],
                price: 32990,
                categories: [mobile._id, smartwatches._id],
                stock: 16
            },

            // ========== ТЕЛЕВИЗОРЫ ==========
            {
                name: "Samsung QLED Q80C 65\"",
                description: "4K QLED телевизор с технологией Quantum HDR, поддержкой HDR10+ и игровым режимом 120 Гц. Яркое и контрастное изображение.",
                images: [],
                price: 129990,
                categories: [tv._id, televisions._id],
                stock: 5
            },
            {
                name: "LG OLED C3 55\"",
                description: "OLED телевизор с идеальным черным цветом, поддержкой Dolby Vision и встроенным голосовым помощником. Кинематографическое качество изображения.",
                images: [],
                price: 109990,
                categories: [tv._id, televisions._id],
                stock: 3
            },

            // ========== АУДИОСТАНАЦИИ ==========
            {
                name: "Sonos Beam Soundbar",
                description: "Компактная звуковая панель с Dolby Atmos, голосовыми помощниками и простой настройкой. Объемный звук для фильмов и музыки.",
                images: [],
                price: 49990,
                categories: [tv._id, audioSystems._id],
                stock: 11
            },

            // ========== КУХОННАЯ ТЕХНИКА ==========
            {
                name: "Philips Airfryer XXL",
                description: "Фритюрница горячим воздухом с технологией Rapid Air, объемом 1.4 кг. Приготовление с минимальным количеством масла.",
                images: [],
                price: 15990,
                categories: [homeTech._id, houseAppliances._id],
                stock: 15
            },
            {
                name: "De'Longhi Dinamica Plus ECAM370.95.T",
                description: "Полностью автоматическая кофемашина с технологией LatteCrema для идеального капучино. 13 степеней помола кофе.",
                images: [],
                price: 79990,
                categories: [homeTech._id, houseAppliances._id],
                stock: 4
            },

            // ========== ТЕХНИКА ДЛЯ УБОРКИ ==========
            {
                name: "Dyson V15 Detect Absolute",
                description: "Беспроводной пылесос с лазерной подсветкой пыли, автоматическим определением типа покрытия и мощной тягой.",
                images: [],
                price: 69990,
                categories: [homeTech._id, cleaningTech._id],
                stock: 8
            },
            {
                name: "iRobot Roomba j7+",
                description: "Робот-пылесос с самоочисткой, навигацией PrecisionVision и функцией избегания препятствий. Умная уборка без участия человека.",
                images: [],
                price: 89990,
                categories: [homeTech._id, cleaningTech._id],
                stock: 6
            },

            // ========== Другая техника ==========
            {
                name: "Xiaomi Smart Air Purifier 4",
                description: "Очиститель воздуха с HEPA фильтром, УФ-стерилизацией и подключением к умному дому. Эффективная очистка от аллергенов и бактерий.",
                images: [],
                price: 14990,
                categories: [homeTech._id, otherTech._id],
                stock: 12
            }
        ]);

        
        console.log('БД успешно заполнена данными о товарах!')
    } catch (error) {
        console.error('Ошибка заполнения базы:', error);
    }
}

await CreateCategories();
await CreateProducts();

mongoose.disconnect();
//src\utils\password.js
import bcrypt from 'bcrypt';

export const hashPassword = async (password) => {
    const saltRounds = 12;
    return await bcrypt.hash(password, saltRounds);
};

export const comparePassword = async (password, hash) => {
    return await bcrypt.compare(password, hash);
};

export const validatePassword = (password) => {
    if (password.length < 6) {
        return 'Пароль должен содержать минимум 6 символов';
    }
    return null;
};
